<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>debAIt</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css" id="hljs-dark">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css" id="hljs-light" disabled>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.1/marked.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.9/purify.min.js"></script>
  <style>
    /* ── Reset & Base ──────────────────────────────────── */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --gold: #c9a96e;
      --gold-hover: #d4b87d;
      --gold-dim: rgba(201, 169, 110, 0.15);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 20px;
      --ease: cubic-bezier(0.25, 0.46, 0.45, 0.94);
      --ease-out: cubic-bezier(0.16, 1, 0.3, 1);
      --font: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'SF Pro Display', 'Helvetica Neue', sans-serif;
      --sidebar-w: 280px;
    }

    [data-theme="dark"] {
      --bg-canvas: #0a0a0a;
      --bg-surface: #141414;
      --bg-elevated: #1a1a1a;
      --bg-hover: #222222;
      --bg-active: #2a2a2a;
      --bg-glass: rgba(20, 20, 20, 0.8);
      --bg-msg-user: #1c1c1c;
      --bg-msg-assistant: transparent;
      --bg-code: #161616;
      --bg-input: rgba(255, 255, 255, 0.04);
      --border: rgba(255, 255, 255, 0.08);
      --border-strong: rgba(255, 255, 255, 0.14);
      --text-primary: #f5f5f7;
      --text-secondary: #a1a1a6;
      --text-tertiary: #6e6e73;
      --text-inverse: #0a0a0a;
      --shadow: 0 1px 3px rgba(0,0,0,0.4);
      --shadow-lg: 0 8px 32px rgba(0,0,0,0.5);
    }

    [data-theme="light"] {
      --bg-canvas: #f5f5f7;
      --bg-surface: #ffffff;
      --bg-elevated: #ffffff;
      --bg-hover: #f0f0f2;
      --bg-active: #e8e8ed;
      --bg-glass: rgba(255, 255, 255, 0.8);
      --bg-msg-user: #f0f0f2;
      --bg-msg-assistant: transparent;
      --bg-code: #f6f8fa;
      --bg-input: rgba(0, 0, 0, 0.03);
      --border: rgba(0, 0, 0, 0.08);
      --border-strong: rgba(0, 0, 0, 0.14);
      --text-primary: #1d1d1f;
      --text-secondary: #6e6e73;
      --text-tertiary: #a1a1a6;
      --text-inverse: #f5f5f7;
      --shadow: 0 1px 3px rgba(0,0,0,0.08);
      --shadow-lg: 0 8px 32px rgba(0,0,0,0.12);
    }

    html, body { height: 100%; overflow: hidden; }

    body {
      font-family: var(--font);
      letter-spacing: -0.01em;
      background: var(--bg-canvas);
      color: var(--text-primary);
      display: flex;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      transition: background 0.3s var(--ease), color 0.3s var(--ease);
    }

    /* ── Scrollbar ─────────────────────────────────────── */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border-strong); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--text-tertiary); }

    /* ── Sidebar ───────────────────────────────────────── */
    .sidebar {
      width: var(--sidebar-w); height: 100%; background: var(--bg-surface);
      border-right: 1px solid var(--border); display: flex; flex-direction: column;
      flex-shrink: 0; transition: transform 0.35s var(--ease-out), opacity 0.35s var(--ease-out); z-index: 100;
    }
    .sidebar.collapsed { transform: translateX(calc(-1 * var(--sidebar-w))); opacity: 0; position: absolute; pointer-events: none; }
    .sidebar-header { padding: 20px 16px 12px; border-bottom: 1px solid var(--border); }
    .sidebar-brand { display: flex; align-items: center; gap: 10px; margin-bottom: 16px; }
    .sidebar-brand svg { flex-shrink: 0; }
    .sidebar-brand span { font-size: 15px; font-weight: 600; color: var(--text-primary); letter-spacing: -0.02em; }
    .sidebar-brand .gold { color: var(--gold); }

    .btn-new-chat {
      width: 100%; padding: 10px 14px; border: 1px solid var(--border-strong); border-radius: var(--radius-md);
      background: transparent; color: var(--text-primary); font-family: var(--font); font-size: 13px;
      font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s var(--ease);
    }
    .btn-new-chat:hover { background: var(--bg-hover); border-color: var(--gold); color: var(--gold); }
    .btn-new-chat .shortcut { margin-left: auto; font-size: 11px; color: var(--text-tertiary); background: var(--bg-hover); padding: 2px 6px; border-radius: 4px; }

    .sidebar-search { padding: 12px 16px 8px; }
    .sidebar-search input {
      width: 100%; padding: 8px 12px; border: 1px solid var(--border); border-radius: var(--radius-sm);
      background: var(--bg-input); color: var(--text-primary); font-family: var(--font); font-size: 13px; outline: none;
      transition: border-color 0.2s var(--ease);
    }
    .sidebar-search input::placeholder { color: var(--text-tertiary); }
    .sidebar-search input:focus { border-color: var(--gold); }
    .sidebar-conversations { flex: 1; overflow-y: auto; padding: 8px 8px; }

    .conv-item {
      padding: 10px 12px; border-radius: var(--radius-sm); cursor: pointer;
      display: flex; align-items: center; gap: 10px; transition: background 0.15s var(--ease); position: relative;
    }
    .conv-item:hover { background: var(--bg-hover); }
    .conv-item.active { background: var(--bg-active); }
    .conv-item-content { flex: 1; min-width: 0; }
    .conv-item-title { font-size: 13px; font-weight: 500; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .conv-item-meta { font-size: 11px; color: var(--text-tertiary); margin-top: 2px; }
    .conv-item .conv-delete { opacity: 0; background: none; border: none; color: var(--text-tertiary); cursor: pointer; padding: 4px; border-radius: 4px; transition: all 0.15s var(--ease); flex-shrink: 0; }
    .conv-item:hover .conv-delete { opacity: 1; }
    .conv-item .conv-delete:hover { color: #ef4444; background: rgba(239, 68, 68, 0.1); }

    .sidebar-footer { padding: 12px 16px; border-top: 1px solid var(--border); display: flex; flex-direction: column; gap: 10px; }
    .model-select-wrapper { position: relative; }
    .model-select-wrapper select {
      width: 100%; padding: 8px 30px 8px 12px; border: 1px solid var(--border); border-radius: var(--radius-sm);
      background: var(--bg-input); color: var(--text-secondary); font-family: var(--font); font-size: 12px;
      cursor: pointer; appearance: none; outline: none; transition: border-color 0.2s var(--ease);
    }
    .model-select-wrapper select:focus { border-color: var(--gold); }
    .model-select-wrapper::after { content: ''; position: absolute; right: 12px; top: 50%; transform: translateY(-50%); width: 0; height: 0; border-left: 4px solid transparent; border-right: 4px solid transparent; border-top: 5px solid var(--text-tertiary); pointer-events: none; }
    .sidebar-footer-row { display: flex; align-items: center; justify-content: space-between; }
    .status-indicator { display: flex; align-items: center; gap: 6px; font-size: 11px; color: var(--text-tertiary); }
    .status-dot { width: 6px; height: 6px; border-radius: 50%; background: #6e6e73; transition: background 0.3s var(--ease); }
    .status-dot.online { background: #30d158; }
    .status-dot.offline { background: #ff453a; }
    .theme-toggle { background: none; border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 6px 8px; cursor: pointer; color: var(--text-secondary); display: flex; align-items: center; gap: 4px; font-size: 11px; font-family: var(--font); transition: all 0.2s var(--ease); }
    .theme-toggle:hover { border-color: var(--gold); color: var(--gold); }

    /* ── Main Area ─────────────────────────────────────── */
    .main { flex: 1; display: flex; flex-direction: column; min-width: 0; height: 100%; position: relative; }
    .main-header { padding: 14px 20px; display: flex; align-items: center; gap: 12px; border-bottom: 1px solid var(--border); background: var(--bg-surface); flex-shrink: 0; }
    .btn-toggle-sidebar { background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 6px; border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; transition: all 0.15s var(--ease); }
    .btn-toggle-sidebar:hover { background: var(--bg-hover); color: var(--text-primary); }
    .main-header-title { font-size: 14px; font-weight: 500; color: var(--text-secondary); flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .btn-export { background: none; border: none; color: var(--text-tertiary); cursor: pointer; padding: 6px; border-radius: var(--radius-sm); display: flex; align-items: center; transition: all 0.15s var(--ease); }
    .btn-export:hover { color: var(--gold); background: var(--gold-dim); }

    /* ── Messages ──────────────────────────────────────── */
    .messages { flex: 1; overflow-y: auto; padding: 24px 20px; scroll-behavior: smooth; }
    .messages-inner { max-width: 768px; margin: 0 auto; display: flex; flex-direction: column; gap: 32px; }

    .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; gap: 16px; opacity: 0.6; }
    .empty-state svg { opacity: 0.4; }
    .empty-state-text { font-size: 20px; font-weight: 500; color: var(--text-secondary); letter-spacing: -0.02em; }
    .empty-state-sub { font-size: 13px; color: var(--text-tertiary); }

    .message-group { display: flex; gap: 12px; animation: msgIn 0.4s var(--ease-out) both; }
    @keyframes msgIn { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
    .message-group.user { flex-direction: row-reverse; }

    .msg-avatar { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; margin-top: 2px; }
    .msg-avatar.user-avatar { background: var(--gold-dim); color: var(--gold); }
    .msg-avatar.assistant-avatar { background: linear-gradient(135deg, var(--gold-dim), rgba(201, 169, 110, 0.25)); color: var(--gold); }
    .msg-avatar.assistant-avatar.codex { background: linear-gradient(135deg, rgba(16, 163, 127, 0.15), rgba(16, 163, 127, 0.25)); color: #10a37f; }
    .msg-avatar.assistant-avatar.gemini { background: linear-gradient(135deg, rgba(66, 133, 244, 0.15), rgba(66, 133, 244, 0.25)); color: #4285f4; }
    .msg-avatar.assistant-avatar.summary-avatar { background: linear-gradient(135deg, rgba(245, 166, 35, 0.15), rgba(245, 166, 35, 0.25)); color: #f5a623; }

    .msg-body { flex: 1; min-width: 0; max-width: 680px; }
    .message-group.user .msg-body { display: flex; flex-direction: column; align-items: flex-end; }
    .msg-label { font-size: 11px; font-weight: 600; letter-spacing: 0.06em; text-transform: uppercase; color: var(--text-tertiary); margin-bottom: 6px; }
    .msg-label.claude-label { color: var(--gold); }
    .msg-label.codex-label { color: #10a37f; }
    .msg-label.gemini-label { color: #4285f4; }
    .msg-label.summary-label { color: #f5a623; }

    .msg-content { padding: 14px 18px; border-radius: var(--radius-lg); line-height: 1.65; font-size: 14.5px; position: relative; }
    .message-group.user .msg-content { background: var(--bg-msg-user); border: 1px solid var(--border); }
    .message-group.assistant .msg-content { background: var(--bg-msg-assistant); }
    .message-group.assistant .msg-content.summary-content { border: 1px solid rgba(245, 166, 35, 0.3); background: rgba(245, 166, 35, 0.04); }
    .message-group.error .msg-content { background: rgba(255, 69, 58, 0.08); border: 1px solid rgba(255, 69, 58, 0.2); color: #ff453a; }

    .msg-actions { display: flex; gap: 4px; margin-top: 6px; opacity: 0; transition: opacity 0.2s var(--ease); }
    .message-group:hover .msg-actions { opacity: 1; }
    .msg-action-btn { background: none; border: 1px solid var(--border); color: var(--text-tertiary); cursor: pointer; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-family: var(--font); display: flex; align-items: center; gap: 4px; transition: all 0.15s var(--ease); }
    .msg-action-btn:hover { color: var(--gold); border-color: var(--gold); background: var(--gold-dim); }
    .msg-meta { font-size: 11px; color: var(--text-tertiary); margin-top: 6px; display: flex; gap: 10px; align-items: center; }
    .message-group.user .msg-meta { justify-content: flex-end; }

    /* ── Markdown Content Styles ───────────────────────── */
    .msg-content h1, .msg-content h2, .msg-content h3, .msg-content h4, .msg-content h5, .msg-content h6 { margin-top: 1.2em; margin-bottom: 0.5em; font-weight: 600; line-height: 1.3; letter-spacing: -0.02em; }
    .msg-content h1:first-child, .msg-content h2:first-child, .msg-content h3:first-child { margin-top: 0; }
    .msg-content h1 { font-size: 1.5em; } .msg-content h2 { font-size: 1.3em; } .msg-content h3 { font-size: 1.1em; }
    .msg-content p { margin: 0.6em 0; } .msg-content p:first-child { margin-top: 0; } .msg-content p:last-child { margin-bottom: 0; }
    .msg-content ul, .msg-content ol { margin: 0.6em 0; padding-left: 1.5em; }
    .msg-content li { margin: 0.25em 0; }
    .msg-content blockquote { border-left: 3px solid var(--gold); padding: 8px 16px; margin: 0.8em 0; color: var(--text-secondary); background: var(--bg-input); border-radius: 0 var(--radius-sm) var(--radius-sm) 0; }
    .msg-content a { color: var(--gold); text-decoration: none; border-bottom: 1px solid transparent; transition: border-color 0.2s var(--ease); }
    .msg-content a:hover { border-bottom-color: var(--gold); }
    .msg-content code:not(pre code) { background: var(--bg-code); padding: 2px 6px; border-radius: 4px; font-size: 0.88em; font-family: 'SF Mono', 'Fira Code', 'Cascadia Code', monospace; border: 1px solid var(--border); }
    .msg-content table { width: 100%; border-collapse: collapse; margin: 0.8em 0; font-size: 0.92em; }
    .msg-content th, .msg-content td { padding: 8px 12px; border: 1px solid var(--border); text-align: left; }
    .msg-content th { background: var(--bg-elevated); font-weight: 600; }
    .msg-content strong { font-weight: 600; } .msg-content em { font-style: italic; }
    .msg-content hr { border: none; border-top: 1px solid var(--border); margin: 1.2em 0; }

    /* ── Code Blocks ───────────────────────────────────── */
    .code-block-wrapper { position: relative; margin: 0.8em 0; border-radius: var(--radius-md); overflow: hidden; border: 1px solid var(--border); }
    .code-block-header { display: flex; align-items: center; justify-content: space-between; padding: 8px 14px; background: var(--bg-elevated); border-bottom: 1px solid var(--border); }
    .code-block-lang { font-size: 11px; font-weight: 500; color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 0.04em; }
    .code-copy-btn { background: none; border: none; color: var(--text-tertiary); cursor: pointer; font-size: 11px; font-family: var(--font); padding: 2px 8px; border-radius: 4px; display: flex; align-items: center; gap: 4px; transition: all 0.15s var(--ease); }
    .code-copy-btn:hover { color: var(--gold); background: var(--gold-dim); }
    .code-block-wrapper pre { margin: 0; padding: 14px; overflow-x: auto; background: var(--bg-code) !important; }
    .code-block-wrapper pre code { font-family: 'SF Mono', 'Fira Code', 'Cascadia Code', monospace; font-size: 13px; line-height: 1.55; background: none !important; padding: 0 !important; }

    /* ── Typing Indicator ──────────────────────────────── */
    .typing-indicator { display: flex; gap: 5px; padding: 14px 18px; align-items: center; }
    .typing-dot { width: 7px; height: 7px; border-radius: 50%; background: var(--gold); opacity: 0.4; animation: typingBounce 1.2s ease-in-out infinite; }
    .typing-dot:nth-child(2) { animation-delay: 0.15s; }
    .typing-dot:nth-child(3) { animation-delay: 0.3s; }
    @keyframes typingBounce { 0%, 60%, 100% { transform: translateY(0); opacity: 0.4; } 30% { transform: translateY(-6px); opacity: 1; } }

    .summary-countdown { display: flex; align-items: center; gap: 10px; padding: 6px 0 0; }
    .summary-countdown .countdown-text { font-size: 12px; color: var(--text-tertiary); font-variant-numeric: tabular-nums; }
    .summary-countdown .countdown-bar { flex: 1; height: 3px; background: var(--border); border-radius: 2px; overflow: hidden; max-width: 200px; }
    .summary-countdown .countdown-fill { height: 100%; background: var(--gold); border-radius: 2px; transition: width 1s linear; }

    /* ── Input Area ────────────────────────────────────── */
    .input-area { padding: 16px 20px 20px; flex-shrink: 0; }
    .input-wrapper { max-width: 768px; margin: 0 auto; background: var(--bg-glass); backdrop-filter: blur(20px) saturate(180%); -webkit-backdrop-filter: blur(20px) saturate(180%); border: 1px solid var(--border-strong); border-radius: var(--radius-xl); padding: 8px 8px 8px 18px; display: flex; align-items: flex-end; gap: 8px; transition: border-color 0.2s var(--ease), box-shadow 0.2s var(--ease); }
    .input-wrapper:focus-within { border-color: var(--gold); box-shadow: 0 0 0 3px rgba(201, 169, 110, 0.1); }
    .input-wrapper textarea { flex: 1; border: none; background: transparent; color: var(--text-primary); font-family: var(--font); font-size: 14.5px; line-height: 1.5; resize: none; outline: none; padding: 8px 0; min-height: 24px; max-height: 192px; }
    .input-wrapper textarea::placeholder { color: var(--text-tertiary); }
    .btn-send { width: 36px; height: 36px; border-radius: 50%; border: none; background: var(--border); color: var(--text-tertiary); cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: all 0.2s var(--ease); }
    .btn-send.active { background: var(--gold); color: var(--text-inverse); }
    .btn-send.active:hover { background: var(--gold-hover); }
    .btn-send.stop { background: #ff453a; color: white; }
    .btn-send.stop:hover { background: #ff6961; }
    .input-hint { text-align: center; font-size: 11px; color: var(--text-tertiary); margin-top: 8px; max-width: 768px; margin-left: auto; margin-right: auto; }

    /* ── Provider Toggle ───────────────────────────────── */
    .provider-toggle { display: flex; border: 1px solid var(--border); border-radius: var(--radius-sm); overflow: hidden; }
    .provider-btn { flex: 1; padding: 7px 0; border: none; background: transparent; color: var(--text-secondary); font-family: var(--font); font-size: 12px; font-weight: 500; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px; transition: all 0.2s var(--ease); }
    .provider-btn + .provider-btn { border-left: 1px solid var(--border); }
    .provider-btn:hover:not(.active):not(.disabled) { background: var(--bg-hover); }
    .provider-btn.active { background: var(--gold-dim); color: var(--gold); font-weight: 600; }
    .provider-btn.disabled { opacity: 0.35; cursor: not-allowed; }

    .vs-dropdown-wrapper { position: relative; margin-top: 6px; }
    .vs-btn { width: 100%; padding: 7px 12px; border: 1px solid var(--border); border-radius: var(--radius-sm); background: transparent; color: var(--text-secondary); font-family: var(--font); font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; transition: all 0.2s var(--ease); }
    .vs-btn:hover { background: var(--bg-hover); border-color: var(--gold); color: var(--gold); }
    .vs-btn.active { background: linear-gradient(135deg, rgba(204, 169, 91, 0.15), rgba(16, 163, 127, 0.15)); border-color: var(--gold); color: var(--text-primary); }
    .vs-btn.disabled { opacity: 0.35; cursor: not-allowed; }
    .vs-btn .vs-chevron { font-size: 10px; transition: transform 0.2s var(--ease); }
    .vs-btn.open .vs-chevron { transform: rotate(180deg); }
    .vs-dropdown { position: absolute; bottom: calc(100% + 4px); left: 0; right: 0; background: var(--bg-elevated); border: 1px solid var(--border-strong); border-radius: var(--radius-sm); overflow: hidden; display: none; z-index: 200; box-shadow: var(--shadow-lg); }
    .vs-dropdown.show { display: block; }
    .vs-dropdown-item { padding: 8px 12px; font-family: var(--font); font-size: 12px; color: var(--text-secondary); cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.15s var(--ease); border: none; background: none; width: 100%; text-align: left; }
    .vs-dropdown-item:hover { background: var(--bg-hover); color: var(--text-primary); }
    .vs-dropdown-item + .vs-dropdown-item { border-top: 1px solid var(--border); }
    .vs-dropdown-item .vs-label { font-weight: 500; }
    .vs-dropdown-item .vs-desc { font-size: 10px; color: var(--text-tertiary); margin-left: auto; }
    .vs-dropdown-item.disabled { opacity: 0.35; cursor: not-allowed; }

    .conv-provider-badge { font-size: 9px; font-weight: 700; letter-spacing: 0.04em; padding: 1px 4px; border-radius: 3px; background: rgba(16, 163, 127, 0.15); color: #10a37f; flex-shrink: 0; }
    .conv-provider-badge.gemini { background: rgba(66, 133, 244, 0.15); color: #4285f4; }
    .conv-provider-badge.discussion { background: linear-gradient(135deg, rgba(204, 169, 91, 0.2), rgba(16, 163, 127, 0.2)); color: var(--text-secondary); }

    /* ── Discussion Controls ───────────────────────────── */
    .discussion-controls { display: flex; align-items: center; justify-content: center; gap: 12px; margin: 16px auto; padding: 10px 16px; max-width: 600px; border: 1px solid var(--border); border-radius: var(--radius-md); background: var(--bg-surface); flex-wrap: wrap; }
    .discussion-controls label { font-size: 12px; color: var(--text-secondary); display: flex; align-items: center; gap: 6px; cursor: pointer; }
    .discussion-controls .round-info { font-size: 12px; color: var(--text-tertiary); font-variant-numeric: tabular-nums; }
    .discussion-controls input[type="number"] { width: 50px; padding: 4px 6px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg-input); color: var(--text-primary); font-family: var(--font); font-size: 12px; text-align: center; }
    .auto-toggle { position: relative; width: 36px; height: 20px; appearance: none; -webkit-appearance: none; background: var(--border-strong); border-radius: 10px; cursor: pointer; transition: background 0.2s var(--ease); border: none; outline: none; }
    .auto-toggle:checked { background: var(--gold); }
    .auto-toggle::after { content: ''; position: absolute; top: 2px; left: 2px; width: 16px; height: 16px; border-radius: 50%; background: white; transition: transform 0.2s var(--ease); }
    .auto-toggle:checked::after { transform: translateX(16px); }

    .btn-continue-round { display: block; margin: 16px auto; padding: 8px 20px; border: 1px solid var(--border); border-radius: var(--radius-sm); background: transparent; color: var(--text-secondary); font-family: var(--font); font-size: 12px; cursor: pointer; transition: all 0.2s var(--ease); }
    .btn-continue-round:hover { background: var(--bg-hover); color: var(--text-primary); }

    .btn-stop-summarize { padding: 6px 14px; border: 1px solid rgba(255, 69, 58, 0.4); border-radius: var(--radius-sm); background: rgba(255, 69, 58, 0.08); color: #ff453a; font-family: var(--font); font-size: 12px; font-weight: 500; cursor: pointer; transition: all 0.2s var(--ease); }
    .btn-stop-summarize:hover { background: rgba(255, 69, 58, 0.15); border-color: rgba(255, 69, 58, 0.6); }

    /* ── Token Counter ─────────────────────────────────── */
    .token-counter { font-size: 11px; color: var(--text-tertiary); display: flex; align-items: center; gap: 8px; font-variant-numeric: tabular-nums; }
    .token-counter span { white-space: nowrap; }

    /* ── Toast ─────────────────────────────────────────── */
    .toast-container { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); z-index: 1000; display: flex; flex-direction: column; gap: 8px; align-items: center; }
    .toast { background: var(--bg-elevated); border: 1px solid var(--border-strong); color: var(--text-primary); padding: 10px 20px; border-radius: var(--radius-md); font-size: 13px; box-shadow: var(--shadow-lg); animation: toastIn 0.3s var(--ease-out), toastOut 0.3s var(--ease) 2.2s forwards; backdrop-filter: blur(20px); }
    @keyframes toastIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes toastOut { from { opacity: 1; } to { opacity: 0; transform: translateY(-10px); } }

    .sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); z-index: 99; backdrop-filter: blur(4px); }
    .sidebar-overlay.visible { display: block; }

    @media (max-width: 768px) {
      .sidebar { position: fixed; left: 0; top: 0; height: 100%; transform: translateX(calc(-1 * var(--sidebar-w))); box-shadow: var(--shadow-lg); }
      .sidebar.open { transform: translateX(0); opacity: 1; pointer-events: auto; }
      .sidebar.collapsed { transform: translateX(calc(-1 * var(--sidebar-w))); }
      .msg-body { max-width: 100%; }
    }
    @media (min-width: 769px) { .sidebar-overlay { display: none !important; } }
  </style>
</head>
<body>
  <div class="sidebar-overlay" id="sidebarOverlay"></div>

  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-brand">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
          <path d="M4 4h6c1.1 0 2 .9 2 2v5c0 1.1-.9 2-2 2H6l-2 2V6c0-1.1.9-2 2-2z" fill="var(--gold)" opacity="0.7"/>
          <path d="M14 9h6c1.1 0 2 .9 2 2v7l-2-2h-4c-1.1 0-2-.9-2-2v-3c0-1.1.9-2 2-2z" fill="var(--gold)" opacity="0.45"/>
        </svg>
        <span>deb<span class="gold">AI</span>t</span>
      </div>
      <button class="btn-new-chat" id="btnNewChat" title="New Chat (Cmd+N)">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        New Chat
        <span class="shortcut">\u2318N</span>
      </button>
    </div>
    <div class="sidebar-search"><input type="text" id="searchConversations" placeholder="Search conversations... (\u2318K)"></div>
    <div class="sidebar-conversations" id="convList"></div>
    <div class="sidebar-footer">
      <div class="provider-toggle" id="providerToggle">
        <button class="provider-btn active" data-provider="claude" id="btnProviderClaude" title="Use Claude (Anthropic)">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none"><path d="M12 2L14.09 8.26L20 9.27L15.55 13.97L16.91 20L12 16.9L7.09 20L8.45 13.97L4 9.27L9.91 8.26L12 2Z" fill="currentColor"/></svg>
          Claude
        </button>
        <button class="provider-btn" data-provider="codex" id="btnProviderCodex" title="Use Codex (OpenAI)">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>
          Codex
        </button>
        <button class="provider-btn" data-provider="gemini" id="btnProviderGemini" title="Use Gemini (Google)">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z" fill="currentColor"/></svg>
          Gemini
        </button>
      </div>
      <div class="vs-dropdown-wrapper">
        <button class="vs-btn" id="btnProviderDiscussion" title="Discussion Mode">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
          VS Debate <span class="vs-chevron">&#9660;</span>
        </button>
        <div class="vs-dropdown" id="vsDropdown"></div>
      </div>
      <div class="model-select-wrapper">
        <select id="modelSelect">
          <option value="">Opus 4.5 (default)</option>
          <option value="claude-sonnet-4-20250514">Sonnet 4</option>
          <option value="claude-haiku-3-5-20241022">Haiku 3.5</option>
        </select>
      </div>
      <div class="sidebar-footer-row">
        <div class="status-indicator"><div class="status-dot" id="statusDot"></div><span id="statusText">Checking...</span></div>
        <button class="theme-toggle" id="themeToggle" title="Toggle theme">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" id="themeIcon">
            <circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
          </svg>
          <span id="themeLabel">Light</span>
        </button>
      </div>
    </div>
  </aside>

  <main class="main">
    <header class="main-header">
      <button class="btn-toggle-sidebar" id="btnToggleSidebar" title="Toggle sidebar (Cmd+\\)">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="9" y1="3" x2="9" y2="21"/></svg>
      </button>
      <div class="main-header-title" id="mainHeaderTitle">New Conversation</div>
      <div class="token-counter" id="tokenCounter" style="display:none;"><span id="tokenCounterText">0 in / 0 out</span></div>
      <button class="btn-export" id="btnExport" title="Export as Markdown (Cmd+Shift+E)">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
      </button>
    </header>
    <div class="messages" id="messages"><div class="messages-inner" id="messagesInner"></div></div>
    <div class="input-area">
      <div class="input-wrapper" id="inputWrapper">
        <textarea id="promptInput" placeholder="Message Claude..." rows="1"></textarea>
        <button class="btn-send" id="btnSend" title="Send message">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" id="sendIcon">
            <line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/>
          </svg>
        </button>
      </div>
      <div class="input-hint">Enter to send, Shift+Enter for new line</div>
    </div>
  </main>

  <div class="toast-container" id="toastContainer"></div>

  <script>
    const API = 'http://localhost:3456';

    // ── DOM Refs ──────────────────────────────────────────
    const $sidebar       = document.getElementById('sidebar');
    const $sidebarOverlay= document.getElementById('sidebarOverlay');
    const $convList      = document.getElementById('convList');
    const $searchInput   = document.getElementById('searchConversations');
    const $modelSelect   = document.getElementById('modelSelect');
    const $statusDot     = document.getElementById('statusDot');
    const $statusText    = document.getElementById('statusText');
    const $themeToggle   = document.getElementById('themeToggle');
    const $themeIcon     = document.getElementById('themeIcon');
    const $themeLabel    = document.getElementById('themeLabel');
    const $mainTitle     = document.getElementById('mainHeaderTitle');
    const $messages      = document.getElementById('messages');
    const $messagesInner = document.getElementById('messagesInner');
    const $promptInput   = document.getElementById('promptInput');
    const $btnSend       = document.getElementById('btnSend');
    const $toastContainer= document.getElementById('toastContainer');
    const $btnProviderClaude = document.getElementById('btnProviderClaude');
    const $btnProviderCodex  = document.getElementById('btnProviderCodex');
    const $btnProviderGemini = document.getElementById('btnProviderGemini');
    const $btnProviderDiscussion = document.getElementById('btnProviderDiscussion');
    const $vsDropdown = document.getElementById('vsDropdown');
    const $tokenCounter = document.getElementById('tokenCounter');
    const $tokenCounterText = document.getElementById('tokenCounterText');

    // ── State ─────────────────────────────────────────────
    let conversations = {};
    let activeConvId = null;
    let isGenerating = false;
    let abortController = null;
    let sidebarOpen = true;
    let currentProvider = 'claude';
    let codexAvailable = false;
    let geminiAvailable = false;
    let discussionParticipants = []; // which providers are in the current debate
    let discussionRoundInProgress = false;
    let autoDiscussionEnabled = false;
    let autoDiscussionRound = 0;
    let autoDiscussionMaxRounds = 20;
    let stopAndSummarizeRequested = false;

    const PROVIDER_MODELS = {
      claude: [
        { value: '', label: 'Opus 4.5 (default)' },
        { value: 'claude-sonnet-4-20250514', label: 'Sonnet 4' },
        { value: 'claude-haiku-3-5-20241022', label: 'Haiku 3.5' },
      ],
      codex: [
        { value: '', label: 'GPT-5.2 Codex (default)' },
        { value: 'o3', label: 'o3' },
        { value: 'o4-mini', label: 'o4-mini' },
        { value: 'gpt-4.1', label: 'GPT-4.1' },
      ],
      gemini: [
        { value: '', label: 'Gemini 2.5 Pro (default)' },
        { value: 'gemini-2.5-flash', label: 'Gemini 2.5 Flash' },
      ],
    };

    // ── Marked + Highlight.js Config ──────────────────────
    marked.setOptions({ breaks: true, gfm: true,
      highlight: function(code, lang) {
        if (lang && hljs.getLanguage(lang)) { try { return hljs.highlight(code, { language: lang }).value; } catch {} }
        try { return hljs.highlightAuto(code).value; } catch {} return code;
      }
    });
    const renderer = new marked.Renderer();
    renderer.code = function(obj) {
      const text = typeof obj === 'string' ? obj : (obj.text || '');
      const lang = (typeof obj === 'object' ? obj.lang : arguments[1]) || '';
      let highlighted;
      if (lang && hljs.getLanguage(lang)) { try { highlighted = hljs.highlight(text, { language: lang }).value; } catch { highlighted = escapeHtml(text); } }
      else { try { highlighted = hljs.highlightAuto(text).value; } catch { highlighted = escapeHtml(text); } }
      const langLabel = lang ? lang.toUpperCase() : 'CODE';
      return `<div class="code-block-wrapper"><div class="code-block-header"><span class="code-block-lang">${langLabel}</span><button class="code-copy-btn" onclick="copyCode(this)"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg> Copy</button></div><pre><code class="hljs${lang ? ' language-' + lang : ''}">${highlighted}</code></pre></div>`;
    };
    marked.use({ renderer });

    function escapeHtml(str) { return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;'); }
    function renderMarkdown(text) { return DOMPurify.sanitize(marked.parse(text), { ADD_ATTR: ['onclick'] }); }

    window.copyCode = function(btn) {
      const code = btn.closest('.code-block-wrapper').querySelector('code').textContent;
      navigator.clipboard.writeText(code).then(() => {
        btn.innerHTML = `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="20 6 9 17 4 12"/></svg> Copied`;
        showToast('Code copied to clipboard');
        setTimeout(() => { btn.innerHTML = `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg> Copy`; }, 2000);
      });
    };

    function showToast(msg) { const t = document.createElement('div'); t.className = 'toast'; t.textContent = msg; $toastContainer.appendChild(t); setTimeout(() => t.remove(), 2600); }

    // ── Theme ─────────────────────────────────────────────
    function getPreferredTheme() { const s = localStorage.getItem('antro-theme'); if (s) return s; return window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark'; }
    function setTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme); localStorage.setItem('antro-theme', theme);
      document.getElementById('hljs-dark').disabled = theme !== 'dark'; document.getElementById('hljs-light').disabled = theme !== 'light';
      $themeLabel.textContent = theme === 'dark' ? 'Light' : 'Dark';
      $themeIcon.innerHTML = theme === 'dark' ? '<circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>' : '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>';
    }
    setTheme(getPreferredTheme());
    $themeToggle.addEventListener('click', () => { setTheme(document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'); });

    // ── Health ─────────────────────────────────────────────
    async function checkHealth() { try { const r = await fetch(API + '/'); if (r.ok) { $statusDot.className = 'status-dot online'; $statusText.textContent = 'Online'; return true; } } catch {} $statusDot.className = 'status-dot offline'; $statusText.textContent = 'Offline'; return false; }
    checkHealth(); setInterval(checkHealth, 5000);

    // ── Provider Management ───────────────────────────────
    function updateModelList(provider) { const models = PROVIDER_MODELS[provider] || PROVIDER_MODELS.claude; $modelSelect.innerHTML = ''; models.forEach(m => { const o = document.createElement('option'); o.value = m.value; o.textContent = m.label; $modelSelect.appendChild(o); }); }
    function providerDisplayName(p) { return { claude: 'Claude', codex: 'Codex', gemini: 'Gemini', summary: 'Summary' }[p] || p; }
    function getAvailableDiscussionProviders() {
      if (discussionParticipants.length > 0) return [...discussionParticipants];
      const p = ['claude']; if (codexAvailable) p.push('codex'); if (geminiAvailable) p.push('gemini'); return p;
    }

    function setProvider(provider, skipConvCheck) {
      if (provider === 'codex' && !codexAvailable) { showToast('Codex unavailable'); return; }
      if (provider === 'gemini' && !geminiAvailable) { showToast('Gemini unavailable'); return; }
      if (provider === 'discussion') { const c = 1 + (codexAvailable?1:0) + (geminiAvailable?1:0); if (c < 2) { showToast('Discussion requires at least 2 providers'); return; } }
      if (!skipConvCheck && activeConvId && conversations[activeConvId]) { const conv = conversations[activeConvId]; if (conv.messages.length > 0 && conv.provider && conv.provider !== provider) { showToast('Cannot switch provider mid-conversation. Start a new chat.'); return; } }
      currentProvider = provider;
      $btnProviderClaude.classList.toggle('active', provider === 'claude');
      $btnProviderCodex.classList.toggle('active', provider === 'codex');
      $btnProviderGemini.classList.toggle('active', provider === 'gemini');
      $btnProviderDiscussion.classList.toggle('active', provider === 'discussion');
      closeVsDropdown();
      if (provider === 'discussion') {
        const names = discussionParticipants.map(p => providerDisplayName(p)).join(' vs ');
        $modelSelect.disabled = true; $modelSelect.innerHTML = '<option value="">Auto</option>';
        $promptInput.placeholder = `Start a ${names} debate...`;
      } else {
        discussionParticipants = [];
        $modelSelect.disabled = false; updateModelList(provider); $promptInput.placeholder = `Message ${providerDisplayName(provider)}...`;
      }
      if (activeConvId && conversations[activeConvId] && conversations[activeConvId].messages.length === 0) { conversations[activeConvId].provider = provider; saveConversations(); }
    }

    // ── VS Dropdown ──────────────────────────────────────
    function buildVsDropdownItems() {
      const allProviders = [
        { id: 'claude', name: 'Claude', available: true },
        { id: 'codex', name: 'Codex', available: codexAvailable },
        { id: 'gemini', name: 'Gemini', available: geminiAvailable },
      ];
      const available = allProviders.filter(p => p.available);
      const items = [];
      // 3-way if all available
      if (available.length >= 3) {
        items.push({ label: 'Claude vs Codex vs Gemini', desc: '3-way debate', participants: ['claude', 'codex', 'gemini'] });
      }
      // All 2-way combinations
      for (let i = 0; i < available.length; i++) {
        for (let j = i + 1; j < available.length; j++) {
          items.push({ label: `${available[i].name} vs ${available[j].name}`, desc: '1v1 debate', participants: [available[i].id, available[j].id] });
        }
      }
      return items;
    }

    function openVsDropdown() {
      const items = buildVsDropdownItems();
      if (items.length === 0) { showToast('Need at least 2 available providers'); return; }
      $vsDropdown.innerHTML = items.map((item, i) =>
        `<button class="vs-dropdown-item" data-idx="${i}"><span class="vs-label">${item.label}</span><span class="vs-desc">${item.desc}</span></button>`
      ).join('');
      $vsDropdown.querySelectorAll('.vs-dropdown-item').forEach((btn, i) => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          discussionParticipants = items[i].participants;
          setProvider('discussion');
        });
      });
      $vsDropdown.classList.add('show');
      $btnProviderDiscussion.classList.add('open');
    }

    function closeVsDropdown() { $vsDropdown.classList.remove('show'); $btnProviderDiscussion.classList.remove('open'); }

    $btnProviderClaude.addEventListener('click', () => setProvider('claude'));
    $btnProviderCodex.addEventListener('click', () => setProvider('codex'));
    $btnProviderGemini.addEventListener('click', () => setProvider('gemini'));
    $btnProviderDiscussion.addEventListener('click', (e) => {
      e.stopPropagation();
      if ($vsDropdown.classList.contains('show')) closeVsDropdown();
      else openVsDropdown();
    });
    document.addEventListener('click', () => closeVsDropdown());

    async function checkProviders() {
      try {
        const res = await fetch(API + '/providers'); const data = await res.json();
        codexAvailable = data.providers?.codex?.available || false;
        geminiAvailable = data.providers?.gemini?.available || false;
        const availCount = 1 + (codexAvailable?1:0) + (geminiAvailable?1:0);
        $btnProviderCodex.classList.toggle('disabled', !codexAvailable);
        $btnProviderGemini.classList.toggle('disabled', !geminiAvailable);
        $btnProviderDiscussion.classList.toggle('disabled', availCount < 2);
        $btnProviderCodex.title = codexAvailable ? 'Use Codex (OpenAI)' : (data.providers?.codex?.warning || 'Codex unavailable');
        $btnProviderGemini.title = geminiAvailable ? 'Use Gemini (Google)' : (data.providers?.gemini?.warning || 'Gemini unavailable');
        $btnProviderDiscussion.title = availCount >= 2 ? 'VS Debate Mode' : 'Requires at least 2 providers';
      } catch { codexAvailable = false; geminiAvailable = false; $btnProviderCodex.classList.add('disabled'); $btnProviderGemini.classList.add('disabled'); $btnProviderDiscussion.classList.add('disabled'); }
    }
    checkProviders(); setInterval(checkProviders, 15000);

    // ── Sidebar Toggle ────────────────────────────────────
    function toggleSidebar() { sidebarOpen = !sidebarOpen; const m = window.innerWidth <= 768; if (m) { $sidebar.classList.toggle('open', sidebarOpen); $sidebar.classList.toggle('collapsed', !sidebarOpen); $sidebarOverlay.classList.toggle('visible', sidebarOpen); } else { $sidebar.classList.toggle('collapsed', !sidebarOpen); } }
    document.getElementById('btnToggleSidebar').addEventListener('click', toggleSidebar);
    $sidebarOverlay.addEventListener('click', () => { sidebarOpen = false; $sidebar.classList.remove('open'); $sidebar.classList.add('collapsed'); $sidebarOverlay.classList.remove('visible'); });
    if (window.innerWidth <= 768) { sidebarOpen = false; $sidebar.classList.add('collapsed'); }

    // ── Persistence ───────────────────────────────────────
    function saveConversations() { localStorage.setItem('antro-conversations', JSON.stringify(conversations)); localStorage.setItem('antro-active-conv', activeConvId || ''); }
    function loadConversations() { try { const s = localStorage.getItem('antro-conversations'); if (s) conversations = JSON.parse(s); activeConvId = localStorage.getItem('antro-active-conv') || null; if (activeConvId && !conversations[activeConvId]) activeConvId = null; } catch { conversations = {}; activeConvId = null; } }

    // ── Conversation Management ───────────────────────────
    function generateId() { return 'conv_' + Date.now() + '_' + Math.random().toString(36).slice(2, 7); }
    function resetAutoDiscussion() { autoDiscussionEnabled = false; autoDiscussionRound = 0; stopAndSummarizeRequested = false; }

    function createNewConversation() {
      const id = generateId();
      conversations[id] = { title: 'New Conversation', messages: [], serverConvId: null, model: $modelSelect.value, provider: currentProvider, created: new Date().toISOString(), updated: new Date().toISOString(), totalTokens: { input: 0, output: 0 } };
      activeConvId = id; resetAutoDiscussion(); saveConversations(); renderSidebar(); renderMessages(); updateHeader(); updateTokenCounter(); $promptInput.focus();
    }

    function switchConversation(id) {
      if (!conversations[id]) return; activeConvId = id; resetAutoDiscussion();
      setProvider(conversations[id].provider || 'claude', true);
      saveConversations(); renderSidebar(); renderMessages(); updateHeader(); updateTokenCounter();
      if (window.innerWidth <= 768) { sidebarOpen = false; $sidebar.classList.remove('open'); $sidebar.classList.add('collapsed'); $sidebarOverlay.classList.remove('visible'); }
    }

    function deleteConversation(id, e) {
      e.stopPropagation(); delete conversations[id];
      if (activeConvId === id) { const ids = Object.keys(conversations).sort((a, b) => new Date(conversations[b].updated) - new Date(conversations[a].updated)); activeConvId = ids[0] || null; }
      saveConversations(); renderSidebar(); renderMessages(); updateHeader();
    }

    function updateHeader() { if (activeConvId && conversations[activeConvId]) { const c = conversations[activeConvId]; $mainTitle.textContent = c.provider === 'discussion' ? 'Discussion: ' + c.title : c.title; } else { $mainTitle.textContent = 'New Conversation'; } }
    function formatTimeAgo(d) { const diff = Date.now() - new Date(d).getTime(); const m = Math.floor(diff/60000); if (m<1) return 'just now'; if (m<60) return m+'m ago'; const h = Math.floor(m/60); if (h<24) return h+'h ago'; const dy = Math.floor(h/24); if (dy<30) return dy+'d ago'; return new Date(d).toLocaleDateString(); }

    // ── Render Sidebar ────────────────────────────────────
    function renderSidebar(filter = '') {
      const sorted = Object.entries(conversations).sort(([,a],[,b]) => new Date(b.updated) - new Date(a.updated));
      $convList.innerHTML = '';
      const filtered = filter ? sorted.filter(([,c]) => c.title.toLowerCase().includes(filter.toLowerCase())) : sorted;
      if (filtered.length === 0) { $convList.innerHTML = `<div style="padding:20px;text-align:center;font-size:12px;color:var(--text-tertiary)">${filter ? 'No matching conversations' : 'No conversations yet'}</div>`; return; }
      filtered.forEach(([id, conv]) => {
        const item = document.createElement('div'); item.className = 'conv-item' + (id === activeConvId ? ' active' : ''); item.onclick = () => switchConversation(id);
        const tc = conv.messages.filter(m => m.role === 'user').length;
        const badge = conv.provider === 'codex' ? '<span class="conv-provider-badge">CX</span>' : conv.provider === 'gemini' ? '<span class="conv-provider-badge gemini">GM</span>' : conv.provider === 'discussion' ? '<span class="conv-provider-badge discussion">VS</span>' : '';
        item.innerHTML = `<div class="conv-item-content"><div class="conv-item-title">${escapeHtml(conv.title)}</div><div class="conv-item-meta">${tc} message${tc!==1?'s':''} \u00B7 ${formatTimeAgo(conv.updated)}</div></div>${badge}<button class="conv-delete" title="Delete conversation"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>`;
        item.querySelector('.conv-delete').onclick = (e) => deleteConversation(id, e);
        $convList.appendChild(item);
      });
    }

    // ── Render Messages ───────────────────────────────────
    function renderMessages() {
      $messagesInner.innerHTML = '';
      if (!activeConvId || !conversations[activeConvId] || conversations[activeConvId].messages.length === 0) {
        const emptyText = currentProvider === 'discussion' ? `Start a discussion between ${getAvailableDiscussionProviders().map(p => providerDisplayName(p)).join(', ')}` : `Start a conversation with ${providerDisplayName(currentProvider)}`;
        $messagesInner.innerHTML = `<div class="empty-state"><svg width="48" height="48" viewBox="0 0 24 24" fill="none"><path d="M12 2L14.09 8.26L20 9.27L15.55 13.97L16.91 20L12 16.9L7.09 20L8.45 13.97L4 9.27L9.91 8.26L12 2Z" fill="var(--gold)" opacity="0.3"/></svg><div class="empty-state-text">What can I help you with?</div><div class="empty-state-sub">${emptyText}</div></div>`;
        return;
      }
      const conv = conversations[activeConvId];
      conv.messages.forEach((msg, idx) => { appendMessageDOM(msg, idx, conv.messages); });

      if (conv.provider === 'discussion' && conv.messages.length > 0) {
        const lastMsg = conv.messages[conv.messages.length - 1];
        if ((lastMsg.role === 'assistant' || lastMsg.role === 'error') && !isGenerating) {
          $messagesInner.appendChild(buildDiscussionControls());
        } else if (isGenerating) {
          const w = document.createElement('div'); w.style.textAlign = 'center'; w.style.margin = '12px 0';
          const b = document.createElement('button'); b.className = 'btn-stop-summarize'; b.textContent = 'Stop & Summarize'; b.onclick = () => handleStopAndSummarize();
          w.appendChild(b); $messagesInner.appendChild(w);
        }
      }
      scrollToBottom();
    }

    function appendMessageDOM(msg, idx, allMessages) {
      const group = document.createElement('div'); group.className = `message-group ${msg.role}`; group.dataset.idx = idx;
      const isUser = msg.role === 'user'; const isLastAssistant = msg.role === 'assistant' && idx === allMessages.length - 1;
      const convProvider = (activeConvId && conversations[activeConvId]?.provider) || 'claude';
      const isDiscussion = convProvider === 'discussion';
      const msgProvider = (isDiscussion && msg.provider) ? msg.provider : (msg.provider || convProvider);
      const isSummary = msgProvider === 'summary';

      const avatarSvgs = {
        user: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`,
        claude: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none"><path d="M12 2L14.09 8.26L20 9.27L15.55 13.97L16.91 20L12 16.9L7.09 20L8.45 13.97L4 9.27L9.91 8.26L12 2Z" fill="currentColor"/></svg>`,
        codex: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>`,
        gemini: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z" fill="currentColor"/></svg>`,
        summary: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>`,
      };
      const avatarClassMap = { codex: 'assistant-avatar codex', gemini: 'assistant-avatar gemini', summary: 'assistant-avatar summary-avatar' };
      const labelMap = { claude: 'Claude', codex: 'Codex', gemini: 'Gemini', summary: 'Summary' };
      const labelClassMap = { claude: 'claude-label', codex: 'codex-label', gemini: 'gemini-label', summary: 'summary-label' };

      const avatarSvg = isUser ? avatarSvgs.user : (avatarSvgs[msgProvider] || avatarSvgs.claude);
      const assistantClass = avatarClassMap[msgProvider] || 'assistant-avatar';
      const assistantLabel = labelMap[msgProvider] || 'Assistant';
      const labelClass = (!isUser && (isDiscussion || isSummary)) ? (labelClassMap[msgProvider] || '') : '';
      const renderedContent = isUser ? escapeHtml(msg.content).replace(/\n/g, '<br>') : renderMarkdown(msg.content);
      const contentClass = isSummary ? 'msg-content summary-content' : 'msg-content';

      let metaHtml = '';
      if (msg.turn) metaHtml += `<span>Turn ${msg.turn}</span>`;
      if (msg.durationMs) metaHtml += `<span>${(msg.durationMs / 1000).toFixed(1)}s</span>`;
      if (msg.tokens && (msg.tokens.input || msg.tokens.output)) { metaHtml += `<span>${((msg.tokens.input||0) + (msg.tokens.output||0)).toLocaleString()} tokens</span>`; }

      let actionsHtml = `<button class="msg-action-btn" onclick="copyMessage(${idx})"><svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg> Copy</button>`;
      if (isUser) actionsHtml += `<button class="msg-action-btn" onclick="editMessage(${idx})"><svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg> Edit</button>`;
      if (isLastAssistant && !isSummary) actionsHtml += `<button class="msg-action-btn" onclick="regenerateMessage()"><svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg> Regenerate</button>`;

      group.innerHTML = `<div class="msg-avatar ${isUser ? 'user-avatar' : assistantClass}">${avatarSvg}</div><div class="msg-body"><div class="msg-label ${labelClass}">${isUser ? 'You' : assistantLabel}</div><div class="${contentClass}">${renderedContent}</div><div class="msg-actions">${actionsHtml}</div>${metaHtml ? `<div class="msg-meta">${metaHtml}</div>` : ''}</div>`;
      $messagesInner.appendChild(group);
    }

    function scrollToBottom() { requestAnimationFrame(() => { $messages.scrollTop = $messages.scrollHeight; }); }

    // ── Message Actions ───────────────────────────────────
    window.copyMessage = function(idx) { if (!activeConvId) return; const msg = conversations[activeConvId].messages[idx]; if (msg) navigator.clipboard.writeText(msg.content).then(() => showToast('Message copied')); };
    window.editMessage = function(idx) {
      if (!activeConvId || isGenerating) return; const conv = conversations[activeConvId]; const msg = conv.messages[idx]; if (!msg || msg.role !== 'user') return;
      conv.messages = conv.messages.slice(0, idx); conv.serverConvId = null; saveConversations(); renderMessages();
      $promptInput.value = msg.content; autoResize(); updateSendButton(); $promptInput.focus();
    };
    window.regenerateMessage = function() {
      if (!activeConvId || isGenerating) return; const conv = conversations[activeConvId]; if (conv.messages.length < 2) return;
      if (conv.provider === 'discussion') { while (conv.messages.length > 0) { if (conv.messages[conv.messages.length-1].role === 'assistant' || conv.messages[conv.messages.length-1].role === 'error') conv.messages.pop(); else break; } saveConversations(); renderMessages(); runDiscussionRound(null); return; }
      const lastMsg = conv.messages[conv.messages.length-1]; if (lastMsg.role !== 'assistant') return; conv.messages.pop();
      const lastUser = [...conv.messages].reverse().find(m => m.role === 'user'); if (!lastUser) return;
      saveConversations(); renderMessages(); sendMessage(lastUser.content);
    };

    // ── Typing Indicator ──────────────────────────────────
    function showTypingIndicator(overrideProvider) {
      const provider = overrideProvider || (activeConvId && conversations[activeConvId]?.provider) || currentProvider;
      const indicatorId = `typingIndicator-${provider}`;
      if (document.getElementById(indicatorId)) return;
      const group = document.createElement('div'); group.className = 'message-group assistant'; group.id = indicatorId;
      const avatarSvgs = { claude: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none"><path d="M12 2L14.09 8.26L20 9.27L15.55 13.97L16.91 20L12 16.9L7.09 20L8.45 13.97L4 9.27L9.91 8.26L12 2Z" fill="currentColor"/></svg>`, codex: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>`, gemini: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z" fill="currentColor"/></svg>` };
      const avatarClassMap = { codex: 'assistant-avatar codex', gemini: 'assistant-avatar gemini' };
      const nameMap = { claude: 'Claude', codex: 'Codex', gemini: 'Gemini' };
      group.innerHTML = `<div class="msg-avatar ${avatarClassMap[provider] || 'assistant-avatar'}">${avatarSvgs[provider] || avatarSvgs.claude}</div><div class="msg-body"><div class="msg-label">${nameMap[provider] || 'AI'} is thinking...</div><div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div></div>`;
      $messagesInner.appendChild(group); scrollToBottom();
    }
    function hideTypingIndicator(provider) { if (provider) { const el = document.getElementById(`typingIndicator-${provider}`); if (el) el.remove(); } else { document.querySelectorAll('[id^="typingIndicator-"]').forEach(el => el.remove()); } }

    // ── Discussion Controls ───────────────────────────────
    function buildDiscussionControls() {
      const w = document.createElement('div'); w.className = 'discussion-controls';
      w.innerHTML = `<button class="btn-continue-round" style="margin:0;">Continue Round</button><label>Auto <input type="checkbox" class="auto-toggle" ${autoDiscussionEnabled?'checked':''}></label><span class="round-info">Round ${autoDiscussionRound} / <input type="number" class="max-rounds-input" value="${autoDiscussionMaxRounds}" min="1" max="50"></span><button class="btn-stop-summarize">Stop &amp; Summarize</button>`;
      w.querySelector('.btn-continue-round').onclick = () => { autoDiscussionRound++; runDiscussionRound(null); };
      w.querySelector('.auto-toggle').onchange = (e) => { autoDiscussionEnabled = e.target.checked; if (autoDiscussionEnabled) { autoDiscussionRound++; runDiscussionRound(null); } };
      w.querySelector('.max-rounds-input').onchange = (e) => { autoDiscussionMaxRounds = Math.max(1, Math.min(50, parseInt(e.target.value) || 20)); };
      w.querySelector('.btn-stop-summarize').onclick = () => handleStopAndSummarize();
      return w;
    }

    // ── Stop & Summarize ──────────────────────────────────
    function handleStopAndSummarize() { stopAndSummarizeRequested = true; autoDiscussionEnabled = false; if (abortController) abortController.abort(); if (!isGenerating) generateSummary(); }

    let summaryCountdownInterval = null;
    function showSummaryCountdown(estimatedMs) {
      stopSummaryCountdown();
      const group = document.createElement('div'); group.className = 'message-group assistant'; group.id = 'summaryCountdown';
      const estimatedSec = Math.ceil(estimatedMs / 1000); let elapsed = 0;
      group.innerHTML = `<div class="msg-avatar assistant-avatar summary-avatar"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg></div><div class="msg-body"><div class="msg-label summary-label">Generating Summary</div><div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div><div class="summary-countdown"><span class="countdown-text" id="countdownText">~${estimatedSec}s remaining</span><div class="countdown-bar"><div class="countdown-fill" id="countdownFill" style="width:0%"></div></div></div></div>`;
      $messagesInner.appendChild(group); scrollToBottom();
      summaryCountdownInterval = setInterval(() => {
        elapsed++; const remaining = Math.max(0, estimatedSec - elapsed); const pct = Math.min(100, (elapsed / estimatedSec) * 100);
        const textEl = document.getElementById('countdownText'); const fillEl = document.getElementById('countdownFill');
        if (textEl) textEl.textContent = remaining > 0 ? `~${remaining}s remaining` : `${elapsed}s elapsed (finishing up...)`;
        if (fillEl) fillEl.style.width = pct + '%';
      }, 1000);
    }
    function stopSummaryCountdown() { if (summaryCountdownInterval) { clearInterval(summaryCountdownInterval); summaryCountdownInterval = null; } const el = document.getElementById('summaryCountdown'); if (el) el.remove(); }

    async function generateSummary() {
      if (!activeConvId) return; const conv = conversations[activeConvId];
      isGenerating = true; updateSendButton();
      const durations = conv.messages.filter(m => m.role === 'assistant' && m.durationMs > 0).map(m => m.durationMs);
      const avg = durations.length > 0 ? durations.reduce((a,b) => a+b, 0) / durations.length : 30000;
      showSummaryCountdown(Math.round(avg * 1.5));

      let transcript = '';
      for (const msg of conv.messages) { if (msg.role === 'user') transcript += `[Human]: ${msg.content}\n\n`; else if (msg.role === 'assistant' && msg.provider) transcript += `[${providerDisplayName(msg.provider)}]: ${msg.content}\n\n`; }
      const summaryPrompt = `You are a neutral moderator. Summarize the following multi-AI discussion. Address:\n\n1. Each participant's main argument and key points\n2. Their conclusions\n3. How opinions changed or evolved during the discussion\n4. Open questions and where to go next\n\nDiscussion transcript:\n\n${transcript}\n\nProvide a clear, structured summary.`;

      const startTime = Date.now();
      try {
        const res = await fetch(API + '/discuss', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ history: [{ role: 'user', content: summaryPrompt, provider: null }], provider: 'claude' }) });
        const data = await res.json(); stopSummaryCountdown();
        if (data.error) { conv.messages.push({ role: 'error', content: 'Summary error: ' + data.error }); }
        else { conv.messages.push({ role: 'assistant', content: data.result, provider: 'summary', durationMs: data.durationMs || (Date.now() - startTime), tokens: data.tokens || null }); if (data.tokens) accumulateTokens(conv, data.tokens); }
      } catch (err) { stopSummaryCountdown(); conv.messages.push({ role: 'error', content: 'Summary failed: ' + err.message }); }
      isGenerating = false; stopAndSummarizeRequested = false; conv.updated = new Date().toISOString();
      saveConversations(); renderMessages(); renderSidebar(); updateSendButton(); updateTokenCounter();
    }

    // ── Token Tracking ────────────────────────────────────
    function accumulateTokens(conv, tokens) { if (!conv.totalTokens) conv.totalTokens = { input: 0, output: 0 }; conv.totalTokens.input += tokens.input || 0; conv.totalTokens.output += tokens.output || 0; }
    function updateTokenCounter() {
      if (!activeConvId || !conversations[activeConvId]) { $tokenCounter.style.display = 'none'; return; }
      const t = conversations[activeConvId].totalTokens || { input: 0, output: 0 };
      if (t.input === 0 && t.output === 0) { $tokenCounter.style.display = 'none'; return; }
      $tokenCounter.style.display = 'flex'; $tokenCounterText.textContent = `${t.input.toLocaleString()} in / ${t.output.toLocaleString()} out`;
    }

    // ── Discussion Round (Parallel) ──────────────────────
    async function runDiscussionRound(userText) {
      if (isGenerating) return;
      if (!activeConvId) createNewConversation();
      const conv = conversations[activeConvId];

      if (userText) {
        conv.messages.push({ role: 'user', content: userText, provider: null });
        resetAutoDiscussion(); autoDiscussionRound = 1; autoDiscussionEnabled = true;
        if (conv.messages.filter(m => m.role === 'user').length === 1) { conv.title = userText.slice(0, 60) + (userText.length > 60 ? '...' : ''); updateHeader(); }
      }

      conv.updated = new Date().toISOString(); isGenerating = true; discussionRoundInProgress = true;
      abortController = new AbortController(); updateSendButton(); saveConversations(); renderMessages();

      function buildHistory() { return conv.messages.filter(m => m.role !== 'error' && m.provider !== 'summary').map(m => ({ role: m.role === 'assistant' ? 'assistant' : 'user', provider: m.provider || null, content: m.content })); }

      const providers = getAvailableDiscussionProviders();
      const respondedProviders = new Set();
      let renderQueue = Promise.resolve();
      function safeRender() { renderQueue = renderQueue.then(() => { renderMessages(); providers.filter(p => !respondedProviders.has(p)).forEach(p => showTypingIndicator(p)); updateTokenCounter(); scrollToBottom(); }); return renderQueue; }

      try {
        providers.forEach(p => showTypingIndicator(p));
        const historySnapshot = buildHistory();

        const fetchPromises = providers.map(provider => {
          return fetch(API + '/discuss', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ history: historySnapshot, provider, participants: providers }), signal: abortController.signal })
          .then(res => res.json())
          .then(data => {
            respondedProviders.add(provider);
            if (data.error) { conv.messages.push({ role: 'error', content: `${providerDisplayName(provider)} error: ${data.error}` }); }
            else { const tokens = data.tokens || null; conv.messages.push({ role: 'assistant', content: data.result, provider, durationMs: data.durationMs, tokens }); if (tokens) accumulateTokens(conv, tokens); }
            conv.updated = new Date().toISOString(); saveConversations();
            return safeRender().then(() => ({ provider, success: !data.error }));
          })
          .catch(err => { respondedProviders.add(provider); if (err.name !== 'AbortError') { conv.messages.push({ role: 'error', content: `${providerDisplayName(provider)} error: ${err.message}` }); safeRender(); } return { provider, success: false }; });
        });
        await Promise.all(fetchPromises);
      } catch (err) { hideTypingIndicator(); if (err.name === 'AbortError') conv.messages.push({ role: 'error', content: 'Discussion stopped by user.' }); }

      conv.updated = new Date().toISOString(); isGenerating = false; discussionRoundInProgress = false; abortController = null;
      saveConversations(); renderMessages(); renderSidebar(); updateSendButton(); updateTokenCounter();

      if (stopAndSummarizeRequested) { stopAndSummarizeRequested = false; generateSummary(); return; }
      if (autoDiscussionRound >= autoDiscussionMaxRounds) { autoDiscussionEnabled = false; generateSummary(); return; }
      if (autoDiscussionEnabled) { if (conv.messages.slice(-providers.length).some(m => m.role === 'assistant')) { setTimeout(() => { autoDiscussionRound++; runDiscussionRound(null); }, 500); } }
      $promptInput.focus();
    }

    // ── Send / Stop ───────────────────────────────────────
    async function sendMessage(text) {
      if (!text || !text.trim()) return; text = text.trim();
      const isDiscussion = currentProvider === 'discussion' || (activeConvId && conversations[activeConvId]?.provider === 'discussion');
      // In discussion mode, sending a message interrupts the current round
      if (isGenerating && isDiscussion) {
        autoDiscussionEnabled = false;
        if (abortController) abortController.abort();
        // Wait for current generation to settle
        await new Promise(r => setTimeout(r, 300));
        isGenerating = false; discussionRoundInProgress = false; abortController = null;
        hideTypingIndicator();
        return runDiscussionRound(text);
      }
      if (isGenerating) return;
      if (isDiscussion) return runDiscussionRound(text);
      if (!activeConvId) createNewConversation();
      const conv = conversations[activeConvId];
      conv.messages.push({ role: 'user', content: text });
      if (conv.messages.filter(m => m.role === 'user').length === 1) { conv.title = text.slice(0, 60) + (text.length > 60 ? '...' : ''); updateHeader(); }
      conv.updated = new Date().toISOString(); saveConversations(); renderMessages(); renderSidebar();
      isGenerating = true; updateSendButton(); showTypingIndicator();

      try {
        const payload = { prompt: text, provider: conv.provider || currentProvider };
        if (conv.serverConvId) payload.conversationId = conv.serverConvId;
        const model = conv.model || $modelSelect.value; if (model) payload.model = model;
        abortController = new AbortController();
        const res = await fetch(API + '/ask', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload), signal: abortController.signal });
        const data = await res.json(); hideTypingIndicator();
        if (data.error) { conv.messages.push({ role: 'error', content: 'Error: ' + data.error }); }
        else { conv.serverConvId = data.conversationId; const tokens = data.tokens || null; conv.messages.push({ role: 'assistant', content: data.result || JSON.stringify(data, null, 2), turn: data.turn, durationMs: data.durationMs, tokens }); if (tokens) accumulateTokens(conv, tokens); }
      } catch (err) { hideTypingIndicator(); conv.messages.push({ role: err.name === 'AbortError' ? 'error' : 'error', content: err.name === 'AbortError' ? 'Generation stopped by user.' : 'Could not reach server. Is it running?' }); }
      conv.updated = new Date().toISOString(); isGenerating = false; abortController = null;
      saveConversations(); renderMessages(); renderSidebar(); updateSendButton(); updateTokenCounter(); $promptInput.focus();
    }
    function stopGeneration() { if (abortController) abortController.abort(); }

    // ── Input Handling ────────────────────────────────────
    function autoResize() { $promptInput.style.height = 'auto'; $promptInput.style.height = Math.min($promptInput.scrollHeight, 192) + 'px'; }
    function updateSendButton() {
      const hasText = $promptInput.value.trim().length > 0;
      if (isGenerating) { $btnSend.className = 'btn-send stop'; $btnSend.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="6" width="12" height="12" rx="2"/></svg>`; $btnSend.title = 'Stop generation'; }
      else { $btnSend.className = 'btn-send' + (hasText ? ' active' : ''); $btnSend.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>`; $btnSend.title = 'Send message'; }
    }
    $promptInput.addEventListener('input', () => { autoResize(); updateSendButton(); });
    $promptInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        const t = $promptInput.value.trim(); if (!t) return;
        const isDisc = currentProvider === 'discussion' || (activeConvId && conversations[activeConvId]?.provider === 'discussion');
        if (isGenerating && !isDisc) return; // block for non-discussion, allow interrupt for discussion
        $promptInput.value = ''; autoResize(); updateSendButton(); sendMessage(t);
      }
    });
    $btnSend.addEventListener('click', () => {
      const t = $promptInput.value.trim();
      const isDisc = currentProvider === 'discussion' || (activeConvId && conversations[activeConvId]?.provider === 'discussion');
      if (isGenerating && !isDisc && !t) { stopGeneration(); return; }
      if (isGenerating && !isDisc) { stopGeneration(); return; }
      if (!t) return;
      $promptInput.value = ''; autoResize(); updateSendButton(); sendMessage(t);
    });

    document.getElementById('btnNewChat').addEventListener('click', () => { createNewConversation(); if (window.innerWidth <= 768) { sidebarOpen = false; $sidebar.classList.remove('open'); $sidebar.classList.add('collapsed'); $sidebarOverlay.classList.remove('visible'); } });
    $searchInput.addEventListener('input', () => { renderSidebar($searchInput.value); });
    document.getElementById('btnExport').addEventListener('click', exportConversation);

    function exportConversation() {
      if (!activeConvId || !conversations[activeConvId]) { showToast('No conversation to export'); return; }
      const conv = conversations[activeConvId]; const isDisc = conv.provider === 'discussion';
      let md = `# ${conv.title}\n\n`; if (isDisc) md += `*Mode: Discussion*\n\n`;
      md += `*Exported from debAIt on ${new Date().toLocaleDateString()}*\n\n---\n\n`;
      const defaultLabel = providerDisplayName(conv.provider || 'claude');
      conv.messages.forEach(msg => {
        if (msg.role === 'user') md += `## You\n\n${msg.content}\n\n`;
        else if (msg.role === 'assistant') { const label = (isDisc || msg.provider === 'summary') && msg.provider ? providerDisplayName(msg.provider) : defaultLabel; md += `## ${label}\n\n${msg.content}\n\n`; if (msg.durationMs) md += `*${(msg.durationMs/1000).toFixed(1)}s*\n\n`; }
        md += `---\n\n`;
      });
      const blob = new Blob([md], { type: 'text/markdown' }); const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `${conv.title.replace(/[^a-z0-9]/gi, '-').toLowerCase()}.md`; a.click(); URL.revokeObjectURL(url);
      showToast('Conversation exported as Markdown');
    }

    // ── Keyboard Shortcuts ────────────────────────────────
    document.addEventListener('keydown', (e) => {
      const isMod = e.metaKey || e.ctrlKey;
      if (isMod && e.key === 'n') { e.preventDefault(); createNewConversation(); }
      if (isMod && e.key === 'k') { e.preventDefault(); if (!sidebarOpen) toggleSidebar(); setTimeout(() => $searchInput.focus(), 100); }
      if (isMod && e.key === '\\') { e.preventDefault(); toggleSidebar(); }
      if (isMod && e.shiftKey && e.key === 'E') { e.preventDefault(); exportConversation(); }
      if (e.key === 'Escape') { if (document.activeElement === $searchInput) { $searchInput.value = ''; $searchInput.blur(); renderSidebar(); } else if (isGenerating) stopGeneration(); }
    });

    // ── Initialize ────────────────────────────────────────
    loadConversations();
    if (activeConvId && conversations[activeConvId]?.provider) setProvider(conversations[activeConvId].provider, true);
    renderSidebar();
    if (activeConvId && conversations[activeConvId]) { renderMessages(); updateHeader(); updateTokenCounter(); } else { renderMessages(); }
    updateSendButton(); $promptInput.focus();
  </script>
</body>
</html>
